<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Impromptu Trainer — Sequential Words + Pie Timer</title>
<style>
  :root{--bg:#ffffff;--fg:#0f172a;--muted:#6b7280;--accent:#0ea5a4}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:20px auto;max-width:960px;color:var(--fg);background:var(--bg)}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{border:1px solid #e6e8eb;border-radius:10px;padding:14px;flex:1 1 320px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input,select,textarea,button{padding:8px;border-radius:8px;border:1px solid #d1d5db;font-size:14px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{background:#0f172a;color:#fff;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .btn.secondary{background:#eef2ff;color:#111;border:1px solid #e6e9ff}
  .big{font-size:28px;font-weight:700;margin-top:6px}
  .display{display:flex;align-items:center;gap:18px}
  .wordspan{font-size:30px;font-weight:600;min-width:220px;text-align:center}
  .pie-wrap{width:110px;height:110px;position:relative}
  .pie{width:100%;height:100%;border-radius:50%;display:grid;place-items:center;background:conic-gradient(var(--accent) 0deg, #e6eef0 0deg)}
  .pie .inner{width:78%;height:78%;border-radius:50%;background:#fff;display:grid;place-items:center;font-weight:700}
  .small{font-size:12px;padding:6px 8px}
  .log{max-height:260px;overflow:auto;border:1px solid #f1f5f9;padding:10px;margin-top:10px;background:#fbfdff}
  .chip{display:inline-block;background:#f3f4f6;padding:6px 10px;border-radius:999px;margin:4px}
  footer{margin-top:18px;font-size:13px;color:var(--muted)}
  @media(max-width:720px){ .display{flex-direction:column;align-items:stretch} .wordspan{font-size:22px} }
</style>
</head>
<body>
<h1>Impromptu Trainer — Sequential Words + Pie Timer</h1>

<div class="row">
  <div class="card">
    <strong>Settings</strong>
    <label>Mode</label>
    <select id="mode">
      <option value="triple">Triple Step (pick N words sequentially)</option>
      <option value="rapid">Rapid Fire (continuous prompts)</option>
    </select>

    <label>Topic / Instruction (for Triple Step)</label>
    <input id="topic" placeholder="E.g., What makes me resilient" />

    <label>Preset list / Custom (custom overrides preset)</label>
    <select id="preset">
      <option value="default">Default word bank</option>
      <option value="everyday">Everyday objects</option>
      <option value="emotions">Emotions</option>
      <option value="analogies">Analogy starters (Rapid)</option>
    </select>
    <textarea id="customList" rows="4" placeholder="Optional: one prompt per line to override preset" style="width:100%;margin-top:8px"></textarea>

    <label>Words per round (Triple Step)</label>
    <input id="wordsCount" type="number" value="6" min="1" />

    <label>Per-word interval (seconds)</label>
    <input id="wordInterval" type="number" value="10" min="1" />

    <label>Rapid Fire: interval (ms) & reps</label>
    <div style="display:flex;gap:8px">
      <input id="rapidInterval" type="number" value="3000" min="200" style="width:120px" />
      <input id="rapidCount" type="number" value="20" min="1" style="width:120px" />
    </div>

    <div class="controls">
      <button id="start" class="btn">Start</button>
      <button id="pause" class="btn secondary" id="pauseBtn">Pause</button>
      <button id="stop" class="btn secondary">Stop</button>
      <button id="next" class="btn secondary">Next</button>
    </div>

    <label style="margin-top:8px">Score / Notes (optional)</label>
    <input id="score" placeholder="7/10, notes..." />
  </div>

  <div class="card">
    <strong>Live</strong>
    <div class="display" style="margin-top:8px">
      <div class="pie-wrap" aria-hidden="true">
        <div id="pie" class="pie"><div class="inner" id="pieInner">10s</div></div>
      </div>
      <div style="flex:1">
        <div class="big" id="roundLabel">Ready</div>
        <div class="wordspan" id="wordDisplay">—</div>
        <div style="margin-top:8px;color:var(--muted)">Upcoming: <span id="upcoming" class="chip">none</span></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <strong>Current word set</strong>
      <div id="wordsArea" style="margin-top:10px"></div>
    </div>

    <div style="margin-top:12px">
      <button id="save" class="btn secondary">Save session (local)</button>
      <button id="export" class="btn">Export CSV</button>
      <button id="clearLog" class="btn secondary">Clear Log</button>
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <strong>Session Log (localStorage)</strong>
  <div class="log" id="log"></div>
</div>

<footer>Keyboard: Space = start/pause, N = next</footer>

<script>
/* Sequential words + pie timer. No backend. Local logs saved to localStorage. */

const presetBanks = {
  default: ["courage","mirror","river","bridge","lamp","truth","forest","anchor","music","hope","curiosity","mountain","storm","compass","book","laughter","journey","shadow","clock","window","light","fear","confidence","persistence","decision","friendship","gratitude","coffee","road","rain","fire","balance","patience","time","goal","habit","seed","tree","teamwork","ocean","learning","energy","focus","reflection","change","challenge","risk","failure","success","discipline"],
  everyday: ["cup","phone","key","door","shoe","bag","pen","table","bus","car","light","glass","plate","bed"],
  emotions: ["joy","anger","curiosity","envy","pride","shame","gratitude","anxiety","surprise","calm","boredom","hope"],
  analogies: [
    "Sun is to day as moon is to ___",
    "Teacher is to student as coach is to ___",
    "Pen is to writer as brush is to ___",
    "River is to water as highway is to ___",
    "Seed is to tree as idea is to ___",
    "Chef is to kitchen as pilot is to ___",
    "Battery is to phone as fuel is to ___"
  ]
};

const el = id => document.getElementById(id);
const state = {
  mode:'triple',
  words:[],
  index:0,
  running:false,
  perWordSecs:10,
  timerInterval:null,
  pieAngle:0,
  remainingMs:0
};

function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function loadPreset(){
  const custom = (el('customList').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  if(custom.length) return custom;
  const p = el('preset').value;
  return Array.isArray(presetBanks[p]) ? presetBanks[p].slice() : presetBanks.default.slice();
}

function pickNRandom(n, bank){
  const src = bank.slice();
  const out=[];
  while(out.length<n && src.length){
    const i = Math.floor(Math.random()*src.length);
    out.push(src.splice(i,1)[0]);
  }
  return out;
}

function renderWordsArea(){
  el('wordsArea').innerHTML = state.words.map((w,i)=>`<span class="chip">${escapeHtml(w)}</span>`).join(' ');
}

function renderUpcoming(){
  const upcoming = state.words.slice(state.index+1, state.index+4).join(', ') || 'none';
  el('upcoming').textContent = upcoming;
}

function setPieProgress(fraction){
  // fraction 0..1
  const angle = Math.max(0, Math.min(1,fraction)) * 360;
  el('pie').style.background = `conic-gradient(var(--accent) 0deg, var(--accent) ${angle}deg, #e6eef0 ${angle}deg)`;
  // inner label seconds
  const secs = Math.ceil(state.remainingMs/1000);
  el('pieInner').textContent = secs + 's';
}

function startSequence(){
  // safer startSequence: validate inputs and ensure words exist
  state.mode = el('mode').value;
  state.perWordSecs = Math.max(1, parseInt(el('wordInterval').value||10));

  // load bank (custom overrides preset)
  const custom = (el('customList').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  let bank = custom.length ? custom : (presetBanks[el('preset').value] ? presetBanks[el('preset').value].slice() : presetBanks.default.slice());

  if(state.mode === 'triple'){
    const n = Math.max(1, parseInt(el('wordsCount').value||6));
    // pick n unique random words
    state.words = (function pickN(n, src){
      const a = src.slice(), out = [];
      while(out.length < n && a.length){
        const i = Math.floor(Math.random()*a.length);
        out.push(a.splice(i,1)[0]);
      }
      return out;
    })(n, bank);
  } else {
    const reps = Math.max(1, parseInt(el('rapidCount').value||20));
    // create repeated sequence up to reps
    if(!bank.length){
      bank = ['Prompt 1']; // fallback
    }
    const out = [];
    for(let i=0;i<reps;i++) out.push(bank[i % bank.length] || `Prompt ${i+1}`);
    state.words = out;
  }

  if(!state.words || state.words.length === 0){
    alert('No prompts available. Check preset selection or add custom prompts.');
    return;
  }

  state.index = 0;
  renderWordsArea();
  el('roundLabel').textContent = `${state.mode === 'triple' ? 'Triple Step' : 'Rapid Fire'} — ${state.words.length} items`;
  startWordTimer();
}


function startWordTimer(){
  stopTimer(); // clear existing
  if(state.index >= state.words.length){
    finishSequence();
    return;
  }
  state.running = true;
  state.remainingMs = state.perWordSecs * 1000;
  updateDisplayForIndex();
  // tick every 100ms for smooth pie
  state.timerInterval = setInterval(()=>{
    state.remainingMs -= 100;
    if(state.remainingMs <= 0){
      // move to next
      state.remainingMs = 0;
      setPieProgress(0);
      clearInterval(state.timerInterval);
      state.index++;
      // short delay 200ms then next
      setTimeout(()=> {
        if(state.index < state.words.length){
          startWordTimer();
        } else {
          finishSequence();
        }
      }, 150);
      return;
    }
    setPieProgress(state.remainingMs / (state.perWordSecs*1000));
  },100);
}

function updateDisplayForIndex(){
  const w = state.words[state.index] || '—';
  el('wordDisplay').textContent = w;
  renderUpcoming();
  setPieProgress(1); // start full
}

function pauseTimer(){
  if(!state.running) return;
  state.running = false;
  clearInterval(state.timerInterval);
  el('roundLabel').textContent = 'Paused';
}

function resumeTimer(){
  if(state.running) return;
  if(state.index >= state.words.length) return;
  state.running = true;
  // continue ticking from remainingMs
  state.timerInterval = setInterval(()=>{
    state.remainingMs -= 100;
    if(state.remainingMs <= 0){
      state.remainingMs = 0;
      setPieProgress(0);
      clearInterval(state.timerInterval);
      state.index++;
      setTimeout(()=> {
        if(state.index < state.words.length){
          startWordTimer();
        } else {
          finishSequence();
        }
      },150);
      return;
    }
    setPieProgress(state.remainingMs / (state.perWordSecs*1000));
  },100);
  el('roundLabel').textContent = `${state.mode === 'triple' ? 'Triple Step' : 'Rapid Fire'}`;
}

function stopTimer(){
  clearInterval(state.timerInterval);
  state.running=false;
  state.index = 0;
  state.words = [];
  el('wordDisplay').textContent = '—';
  el('roundLabel').textContent = 'Stopped';
  el('wordsArea').innerHTML = '';
  el('upcoming').textContent = 'none';
  setPieProgress(0);
}

function nextWordManual(){
  // jump to next word immediately
  clearInterval(state.timerInterval);
  state.index++;
  if(state.index < state.words.length){
    startWordTimer();
  } else {
    finishSequence();
  }
}

function finishSequence(){
  clearInterval(state.timerInterval);
  state.running=false;
  el('roundLabel').textContent = 'Finished';
  el('wordDisplay').textContent = 'Done';
  saveLog({mode:state.mode, when:new Date().toLocaleString(), topic: el('topic').value||'', words: state.words.join(' | '), score: el('score').value||''});
  renderLog();
}

/* Logging */
function saveLog(entry){
  const logs = JSON.parse(localStorage.getItem('impromptuLogs') || '[]');
  logs.unshift(entry);
  localStorage.setItem('impromptuLogs', JSON.stringify(logs.slice(0,500)));
}
function renderLog(){
  const logs = JSON.parse(localStorage.getItem('impromptuLogs') || '[]');
  if(!logs.length){ el('log').innerHTML = '<small>No sessions yet.</small>'; return; }
  el('log').innerHTML = logs.map(l => `<div style="margin-bottom:8px"><strong>${escapeHtml(l.mode)}</strong> • ${escapeHtml(l.when)} • ${escapeHtml(l.topic||'')}<div style="font-size:13px;color:${'#374151'};margin-top:4px">${escapeHtml(l.words)}</div><div style="font-size:12px;color:${'#6b7280'}">score: ${escapeHtml(l.score||'')}</div></div>`).join('');
}

/* CSV export */
function exportCSV(){
  const logs = JSON.parse(localStorage.getItem('impromptuLogs') || '[]');
  if(!logs.length){ alert('No sessions to export.'); return; }
  const rows = ['mode,when,topic,words,score', ...logs.map(l => `${csvSafe(l.mode)},${csvSafe(l.when)},${csvSafe(l.topic)},${csvSafe(l.words)},${csvSafe(l.score)}`)];
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'impromptu_sessions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function csvSafe(v){ return `"${String(v||'').replace(/"/g,'""')}"`; }

/* UI bindings */
el('start').addEventListener('click', ()=> {
  if(state.running){ pauseTimer(); return; }
  startSequence();
});
el('pause').addEventListener('click', ()=> {
  if(state.running) pauseTimer(); else resumeTimer();
});
el('stop').addEventListener('click', stopTimer);
el('next').addEventListener('click', nextWordManual);
el('save').addEventListener('click', ()=> {
  saveLog({mode: el('mode').value, when: new Date().toLocaleString(), topic: el('topic').value||'', words: (state.words||[]).join(' | '), score: el('score').value||''});
  renderLog();
  alert('Saved locally.');
});
el('export').addEventListener('click', exportCSV);
el('clearLog').addEventListener('click', ()=> {
  if(confirm('Clear saved sessions?')){ localStorage.removeItem('impromptuLogs'); renderLog(); }
});

/* keyboard */
document.addEventListener('keydown', e=>{
  if(e.key === ' '){ e.preventDefault(); if(state.running) pauseTimer(); else { if(state.words.length) resumeTimer(); else startSequence(); } }
  if(e.key.toLowerCase() === 'n') nextWordManual();
});

/* initial render */
renderLog();
setPieProgress(0);
</script>
</body>
</html>
