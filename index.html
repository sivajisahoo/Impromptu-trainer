<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Impromptu Trainer — Triple Step & Rapid Fire</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;max-width:900px;margin:24px auto;color:#111}
  h1{margin:0 0 12px;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{border:1px solid #ddd;border-radius:8px;padding:12px;flex:1 1 300px}
  label{display:block;margin:8px 0 4px;font-size:13px}
  input,select,textarea,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
  button{cursor:pointer}
  .big{font-size:28px;font-weight:600;margin:8px 0}
  .words{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{background:#f2f2f2;padding:6px 10px;border-radius:16px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #e6e6e6;padding:6px;text-align:left;font-size:13px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .small{font-size:12px;padding:6px 8px}
  .log{max-height:200px;overflow:auto;border:1px solid #eee;padding:8px;margin-top:8px;background:#fafafa}
</style>
</head>
<body>
<h1>Impromptu Trainer — Triple Step & Rapid Fire</h1>

<div class="row">
  <div class="card">
    <strong>Mode</strong>
    <div style="margin-top:8px">
      <select id="mode">
        <option value="triple">Triple Step</option>
        <option value="rapid">Rapid Fire</option>
      </select>
    </div>

    <label>Topic / Instruction (for Triple Step)</label>
    <input id="topic" placeholder="E.g., What makes me resilient" />

    <label>Custom prompt list (one per line)</label>
    <textarea id="customList" rows="6" placeholder="Write words / prompts / analogies here. One per line."></textarea>

    <label>Preset lists</label>
    <select id="preset">
      <option value="default">Default word bank</option>
      <option value="everyday">Everyday objects</option>
      <option value="emotions">Emotions / traits</option>
      <option value="analogies">Analogy starters (for Rapid Fire)</option>
    </select>

    <div style="margin-top:8px">
      <label>Words per round (Triple Step)</label>
      <input id="wordsCount" type="number" value="6" min="1" />
      <label style="margin-top:8px">Round length seconds</label>
      <input id="roundTime" type="number" value="60" min="5" />
    </div>

    <div style="margin-top:8px">
      <label>Rapid Fire: interval ms</label>
      <input id="rapidInterval" type="number" value="3000" min="300" />
      <label style="margin-top:8px">Reps (Rapid Fire)</label>
      <input id="rapidCount" type="number" value="20" min="1" />
    </div>
  </div>

  <div class="card">
    <strong>Session</strong>
    <div class="big" id="timer">00:00</div>
    <div id="currentDisplay" class="big">Ready</div>

    <div class="controls">
      <button id="start" class="small">Start</button>
      <button id="pause" class="small">Pause</button>
      <button id="stop" class="small">Stop</button>
      <button id="next" class="small">Next (Rapid)</button>
      <button id="save" class="small">Save session</button>
      <button id="export" class="small">Export CSV</button>
      <button id="clearLog" class="small">Clear Log</button>
    </div>

    <div style="margin-top:10px">
      <label>Score / Notes</label>
      <input id="score" placeholder="E.g., 7/10 or notes" />
    </div>

    <div style="margin-top:12px">
      <strong>Current word set</strong>
      <div class="words" id="wordsArea"></div>
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <strong>Session Log</strong>
  <div class="log" id="log"></div>
</div>

<script>
const presetBanks = {
  default: ["apple","bridge","clock","river","honesty","engine","salt","window","path","mirror","fear","laughter","book","market","lamp","journey","anchor","signal","forest","ticket","home","courage","summer","decision","music","chair"],
  everyday: ["cup","phone","key","door","shoe","bag","pen","table","bus","car","light","glass","plate","bed","shoe"],
  emotions: ["joy","anger","curiosity","envy","pride","shame","gratitude","anxiety","surprise","calm","boredom","hope"],
  analogies: [
    "Sun is to day as moon is to ___",
    "Teacher is to student as coach is to ___",
    "Pen is to writer as brush is to ___",
    "River is to water as highway is to ___",
    "Seed is to tree as idea is to ___",
    "Chef is to kitchen as pilot is to ___",
    "Battery is to phone as fuel is to ___"
  ]
};

const state = {
  mode: 'triple',
  words: [],
  timerId: null,
  remaining: 0,
  running:false,
  rapidIndex:0,
  rapidCount:20
};

const el = id => document.getElementById(id);
const saveLog = (entry) => {
  const logs = JSON.parse(localStorage.getItem('impromptuLogs')||'[]');
  logs.unshift(entry);
  localStorage.setItem('impromptuLogs', JSON.stringify(logs.slice(0,200)));
  renderLog();
};

function renderLog(){
  const logs = JSON.parse(localStorage.getItem('impromptuLogs')||'[]');
  const out = logs.map(l => `<div><strong>${l.mode.toUpperCase()}</strong> ${l.when} — topic:${escapeHtml(l.topic||'')} score:${escapeHtml(l.score||'')} <div style="font-size:12px;color:#555">${escapeHtml(l.words||'')}</div></div>`).join('');
  el('log').innerHTML = out || '<small>No sessions yet.</small>';
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function pickWords(n, bank){
  const arr = bank.slice();
  const out=[];
  while(out.length<n && arr.length){
    const i = Math.floor(Math.random()*arr.length);
    out.push(arr.splice(i,1)[0]);
  }
  return out;
}

function loadPreset(){
  const p = el('preset').value;
  const custom = (el('customList').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
  if(custom.length) return custom;
  return presetBanks[p] || presetBanks.default;
}

function startTriple(){
  const wordsCount = Math.max(1,parseInt(el('wordsCount').value||6));
  const bank = loadPreset();
  state.words = pickWords(wordsCount, bank);
  el('wordsArea').innerHTML = state.words.map(w=>`<div class="chip">${escapeHtml(w)}</div>`).join('');
  const secs = Math.max(5, parseInt(el('roundTime').value||60));
  state.remaining = secs;
  el('currentDisplay').textContent = el('topic').value || 'Triple Step';
  tickDisplay();
  runTimer(() => {
    state.running = false;
    saveLog({mode:'triple',when:new Date().toLocaleString(),topic:el('topic').value||'',words:state.words.join(', '),score:el('score').value||''});
  });
}

function startRapid(){
  const bank = loadPreset();
  state.rapidCount = Math.max(1,parseInt(el('rapidCount').value||20));
  state.rapidInterval = Math.max(200,parseInt(el('rapidInterval').value||3000));
  state.words = bank.slice();
  state.rapidIndex = 0;
  el('wordsArea').innerHTML = '';
  el('currentDisplay').textContent = 'Rapid Fire';
  tickDisplay();
  state.running = true;
  state.timerId = setInterval(() => {
    if(state.rapidIndex >= state.rapidCount){
      stopTimer();
      saveLog({mode:'rapid',when:new Date().toLocaleString(),topic:'Rapid session',words:`${state.rapidIndex} reps`,score:el('score').value||''});
      return;
    }
    const item = state.words.length ? state.words[state.rapidIndex % state.words.length] : `Prompt ${state.rapidIndex+1}`;
    el('currentDisplay').textContent = item;
    state.rapidIndex++;
    tickDisplay();
  }, state.rapidInterval);
}

function runTimer(callbackOnEnd){
  clearInterval(state.timerId);
  state.running = true;
  el('pause').disabled = false;
  state.timerId = setInterval(()=> {
    state.remaining--;
    tickDisplay();
    if(state.remaining <= 0){
      clearInterval(state.timerId);
      state.running = false;
      el('currentDisplay').textContent = 'Time up';
      if(typeof callbackOnEnd === 'function') callbackOnEnd();
    }
  },1000);
}

function stopTimer(){
  clearInterval(state.timerId);
  state.running = false;
  el('currentDisplay').textContent = 'Stopped';
  el('timer').textContent = '00:00';
  state.remaining = 0;
}

function pauseTimer(){
  if(!state.running) return;
  clearInterval(state.timerId);
  state.running = false;
  el('currentDisplay').textContent = 'Paused';
}

function tickDisplay(){
  const mm = String(Math.floor(state.remaining/60)).padStart(2,'0');
  const ss = String(state.remaining%60).padStart(2,'0');
  el('timer').textContent = `${mm}:${ss}`;
}

function nextRapid(){
  if(!state.running) return;
  clearInterval(state.timerId);
  const item = state.words.length ? state.words[state.rapidIndex % state.words.length] : `Prompt ${state.rapidIndex+1}`;
  el('currentDisplay').textContent = item;
  state.rapidIndex++;
  state.timerId = setInterval(()=> {
    if(state.rapidIndex >= state.rapidCount){
      stopTimer();
      saveLog({mode:'rapid',when:new Date().toLocaleString(),topic:'Rapid session',words:`${state.rapidIndex} reps`,score:el('score').value||''});
      return;
    }
    const it = state.words.length ? state.words[state.rapidIndex % state.words.length] : `Prompt ${state.rapidIndex+1}`;
    el('currentDisplay').textContent = it;
    state.rapidIndex++;
  }, state.rapidInterval);
}

el('mode').addEventListener('change', e=>{
  state.mode = e.target.value;
});
el('preset').addEventListener('change', ()=>{});
el('start').addEventListener('click', ()=>{
  if(state.mode === 'triple' || el('mode').value==='triple'){
    startTriple();
  } else {
    startRapid();
  }
});
el('pause').addEventListener('click', pauseTimer);
el('stop').addEventListener('click', stopTimer);
el('next').addEventListener('click', nextRapid);
el('save').addEventListener('click', ()=>{
  saveLog({mode: el('mode').value, when:new Date().toLocaleString(), topic: el('topic').value||'', words: (state.words||[]).join(', '), score: el('score').value||''});
  alert('Saved to local log.');
});
el('clearLog').addEventListener('click', ()=>{
  if(confirm('Clear saved sessions?')){ localStorage.removeItem('impromptuLogs'); renderLog(); }
});
el('export').addEventListener('click', ()=>{
  const logs = JSON.parse(localStorage.getItem('impromptuLogs')||'[]');
  if(!logs.length){ alert('No sessions to export.'); return; }
  const csv = ['mode,when,topic,words,score', ...logs.map(l=>`${csvSafe(l.mode)},${csvSafe(l.when)},${csvSafe(l.topic)},${csvSafe(l.words)},${csvSafe(l.score)}`)].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'impromptu_sessions.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
function csvSafe(v){ return `"${String(v||'').replace(/"/g,'""')}"`; }

renderLog();

document.addEventListener('keydown', e=>{
  if(e.key === ' '){ e.preventDefault(); if(state.running) pauseTimer(); else document.getElementById('start').click(); }
  if(e.key === 'n') nextRapid();
});
</script>
</body>
</html>
